<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Alarm Cabinent: PIC Code/SNTP Customised.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Alarm Cabinent</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#define-members">Defines</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">PIC Code/SNTP Customised.c File Reference</div>  </div>
</div>
<div class="contents">
<div class="textblock"><code>#include &quot;TCPIP Stack/TCPIP.h&quot;</code><br/>
<code>#include &quot;<a class="el" href="_security_system_8h_source.html">SecuritySystem.h</a>&quot;</code><br/>
</div><div class="textblock"><div class="dynheader">
Include dependency graph for SNTP Customised.c:</div>
<div class="dyncontent">
<div class="center"><iframe src="_s_n_t_p_01_customised_8c__incl.svg" width="547" height="150" frameborder="0" scrolling="no"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<p><a href="_s_n_t_p_01_customised_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct___n_t_p___p_a_c_k_e_t.html">_NTP_PACKET</a></td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Defines the structure of an NTP packet.  <a href="struct___n_t_p___p_a_c_k_e_t.html#details">More...</a><br/></td></tr>
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_s_n_t_p_01_customised_8c.html#af1b13930ddb15a1e204c12ab27561450">__SNTP_C</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_s_n_t_p_01_customised_8c.html#a5fa19ad7b1377cb36ed0f84b32dcfc28">NTP_QUERY_INTERVAL</a>&#160;&#160;&#160;(10ull*60ull * TICK_SECOND)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Defines how frequently to resynchronize the date/time (default: 10 minutes)  <a href="#a5fa19ad7b1377cb36ed0f84b32dcfc28"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_s_n_t_p_01_customised_8c.html#af50690220da7a646605fbb6ca213500a">NTP_FAST_QUERY_INTERVAL</a>&#160;&#160;&#160;(14ull * TICK_SECOND)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_s_n_t_p_01_customised_8c.html#a57df452a6d54697643631ce3039623d4">NTP_SERVER_PORT</a>&#160;&#160;&#160;(123ul)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Port for contacting NTP servers.  <a href="#a57df452a6d54697643631ce3039623d4"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_s_n_t_p_01_customised_8c.html#a600d45a89709a133823847c1f15925dd">NTP_EPOCH</a>&#160;&#160;&#160;(86400ul * (365ul * 70ul + 17ul))</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Reference Epoch to use. (default: 01-Jan-1970 00:00:00)  <a href="#a600d45a89709a133823847c1f15925dd"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_s_n_t_p_01_customised_8c.html#ae0247c4467b3305a0b009bc4e032b23a">NTP_REPLY_TIMEOUT</a>&#160;&#160;&#160;(6ul*TICK_SECOND)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Defines how long to wait before assuming the require has failed.  <a href="#ae0247c4467b3305a0b009bc4e032b23a"></a><br/></td></tr>
<tr><td colspan="2"><h2><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct___n_t_p___p_a_c_k_e_t.html">_NTP_PACKET</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_s_n_t_p_01_customised_8c.html#a208c6f4fdb96fa3116c3252900c29f86">NTP_PACKET</a></td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Defines the structure of an NTP packet.  <a href="#a208c6f4fdb96fa3116c3252900c29f86"></a><br/></td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_s_n_t_p_01_customised_8c.html#aab450595216ff490634099f3ec8efb55">HTTPPrint_NTPServer</a> (void)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Prints the NTP server that if configured.  <a href="#aab450595216ff490634099f3ec8efb55"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_s_n_t_p_01_customised_8c.html#a160897e1fac75ed65f86f3e22e4065b9">HTTPPrint_AES_Active</a> (void)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Prints Is AES active, if no then NTP is not enabled.  <a href="#a160897e1fac75ed65f86f3e22e4065b9"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_s_n_t_p_01_customised_8c.html#adac06bc5849a60fe8b4739c26ff2cd8a">HTTPPrint_NTPLastUpdate</a> (void)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Prints the last time update.  <a href="#adac06bc5849a60fe8b4739c26ff2cd8a"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_s_n_t_p_01_customised_8c.html#a161e949048f06530e2b7bc36388d7241">HTTPPrint_CurrentEPOC</a> (void)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Prints the current EPOC.  <a href="#a161e949048f06530e2b7bc36388d7241"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_s_n_t_p_01_customised_8c.html#ab7d525c89c963594778df06040fc6748">HTTPPrint_SNTPTestOutput</a> (void)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">For debug purposes, prints the result code.  <a href="#ab7d525c89c963594778df06040fc6748"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_s_n_t_p_01_customised_8c.html#a7ee3d58d5355075489e71a6cd73dc307">SNTPClient</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">DWORD&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_s_n_t_p_01_customised_8c.html#a3a2bcda2ac33aacd49d652a93f9031b1">SNTPGetUTCSeconds</a> (void)</td></tr>
<tr><td colspan="2"><h2><a name="var-members"></a>
Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">DWORD&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_s_n_t_p_01_customised_8c.html#afbf3efc6491790a0a132b97f2fd78e4a">dwSNTPSeconds</a> = 0</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Seconds value obtained by last update.  <a href="#afbf3efc6491790a0a132b97f2fd78e4a"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">DWORD&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_s_n_t_p_01_customised_8c.html#a134d28a3f8166df7163955525f14b25d">dwLastUpdateTick</a></td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Tick count of last update.  <a href="#a134d28a3f8166df7163955525f14b25d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_s_n_t_p_01_customised_8c.html#a6fec3fdfff459a953822db2e8ff9b462">NTPTestResponse</a></td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">stores the response from a SNTP test  <a href="#a6fec3fdfff459a953822db2e8ff9b462"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99">SNTPStates</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_s_n_t_p_01_customised_8c.html#ac6e22465161b7de2caf5f35cea78318e">SNTPState</a></td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="af1b13930ddb15a1e204c12ab27561450"></a><!-- doxytag: member="SNTP Customised.c::__SNTP_C" ref="af1b13930ddb15a1e204c12ab27561450" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define __SNTP_C</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00058">58</a> of file <a class="el" href="_s_n_t_p_01_customised_8c_source.html">SNTP Customised.c</a>.</p>

</div>
</div>
<a class="anchor" id="a600d45a89709a133823847c1f15925dd"></a><!-- doxytag: member="SNTP Customised.c::NTP_EPOCH" ref="a600d45a89709a133823847c1f15925dd" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NTP_EPOCH&#160;&#160;&#160;(86400ul * (365ul * 70ul + 17ul))</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Reference Epoch to use. (default: 01-Jan-1970 00:00:00) </p>

<p>Definition at line <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00078">78</a> of file <a class="el" href="_s_n_t_p_01_customised_8c_source.html">SNTP Customised.c</a>.</p>

<p>Referenced by <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00235">SNTPClient()</a>.</p>

</div>
</div>
<a class="anchor" id="af50690220da7a646605fbb6ca213500a"></a><!-- doxytag: member="SNTP Customised.c::NTP_FAST_QUERY_INTERVAL" ref="af50690220da7a646605fbb6ca213500a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NTP_FAST_QUERY_INTERVAL&#160;&#160;&#160;(14ull * TICK_SECOND)</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Defines how long to wait to retry an update after a failure. Updates may take up to 6 seconds to fail, so this 14 second delay is actually only an 8-second retry. </p>

<p>Definition at line <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00072">72</a> of file <a class="el" href="_s_n_t_p_01_customised_8c_source.html">SNTP Customised.c</a>.</p>

<p>Referenced by <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00235">SNTPClient()</a>.</p>

</div>
</div>
<a class="anchor" id="a5fa19ad7b1377cb36ed0f84b32dcfc28"></a><!-- doxytag: member="SNTP Customised.c::NTP_QUERY_INTERVAL" ref="a5fa19ad7b1377cb36ed0f84b32dcfc28" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NTP_QUERY_INTERVAL&#160;&#160;&#160;(10ull*60ull * TICK_SECOND)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Defines how frequently to resynchronize the date/time (default: 10 minutes) </p>

<p>Definition at line <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00068">68</a> of file <a class="el" href="_s_n_t_p_01_customised_8c_source.html">SNTP Customised.c</a>.</p>

<p>Referenced by <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00235">SNTPClient()</a>.</p>

</div>
</div>
<a class="anchor" id="ae0247c4467b3305a0b009bc4e032b23a"></a><!-- doxytag: member="SNTP Customised.c::NTP_REPLY_TIMEOUT" ref="ae0247c4467b3305a0b009bc4e032b23a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NTP_REPLY_TIMEOUT&#160;&#160;&#160;(6ul*TICK_SECOND)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Defines how long to wait before assuming the require has failed. </p>

<p>Definition at line <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00081">81</a> of file <a class="el" href="_s_n_t_p_01_customised_8c_source.html">SNTP Customised.c</a>.</p>

<p>Referenced by <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00235">SNTPClient()</a>.</p>

</div>
</div>
<a class="anchor" id="a57df452a6d54697643631ce3039623d4"></a><!-- doxytag: member="SNTP Customised.c::NTP_SERVER_PORT" ref="a57df452a6d54697643631ce3039623d4" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NTP_SERVER_PORT&#160;&#160;&#160;(123ul)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Port for contacting NTP servers. </p>

<p>Definition at line <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00075">75</a> of file <a class="el" href="_s_n_t_p_01_customised_8c_source.html">SNTP Customised.c</a>.</p>

<p>Referenced by <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00235">SNTPClient()</a>.</p>

</div>
</div>
<hr/><h2>Typedef Documentation</h2>
<a class="anchor" id="a208c6f4fdb96fa3116c3252900c29f86"></a><!-- doxytag: member="SNTP Customised.c::NTP_PACKET" ref="a208c6f4fdb96fa3116c3252900c29f86" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct___n_t_p___p_a_c_k_e_t.html">_NTP_PACKET</a>  <a class="el" href="struct___n_t_p___p_a_c_k_e_t.html">NTP_PACKET</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Defines the structure of an NTP packet. </p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a160897e1fac75ed65f86f3e22e4065b9"></a><!-- doxytag: member="SNTP Customised.c::HTTPPrint_AES_Active" ref="a160897e1fac75ed65f86f3e22e4065b9" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void HTTPPrint_AES_Active </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Prints Is AES active, if no then NTP is not enabled. </p>

<p>Definition at line <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00148">148</a> of file <a class="el" href="_s_n_t_p_01_customised_8c_source.html">SNTP Customised.c</a>.</p>

<p>References <a class="el" href="_security_system_8h_source.html#l00215">xPLConfigs::Use_AES</a>, and <a class="el" href="_security_system_8c_source.html#l00136">xPLConfig</a>.</p>
<div class="fragment"><pre class="fragment">                                 {

        TCPPut(sktHTTP, (<a class="code" href="_security_system_8c.html#adaa5e54872217e9a75a2bfdadf293d12" title="Configuration entries.">xPLConfig</a>.<a class="code" href="structx_p_l_configs.html#aece9a02d06221a468e469a45e371be01" title="Use AES encryption on the user feild in the xPL message.">Use_AES</a>?<span class="charliteral">&#39;1&#39;</span>:<span class="charliteral">&#39;0&#39;</span>));

}
</pre></div>
</div>
</div>
<a class="anchor" id="a161e949048f06530e2b7bc36388d7241"></a><!-- doxytag: member="SNTP Customised.c::HTTPPrint_CurrentEPOC" ref="a161e949048f06530e2b7bc36388d7241" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void HTTPPrint_CurrentEPOC </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Prints the current EPOC. </p>

<p>Definition at line <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00171">171</a> of file <a class="el" href="_s_n_t_p_01_customised_8c_source.html">SNTP Customised.c</a>.</p>

<p>References <a class="el" href="_custom_s_n_t_p_8c_source.html#l00470">SNTPGetUTCSeconds()</a>.</p>
<div class="fragment"><pre class="fragment">                                  {
<span class="preprocessor">#if defined(STACK_USE_SNTP_CLIENT)</span>
<span class="preprocessor"></span>        <span class="keywordtype">char</span> Tempdigit[12];
        
        uitoa((<a class="code" href="_custom_s_n_t_p_8c.html#a3a2bcda2ac33aacd49d652a93f9031b1">SNTPGetUTCSeconds</a>() / TICK_SECOND), Tempdigit);
        TCPPutArray(sktHTTP, Tempdigit, strlen((<span class="keywordtype">char</span>*)Tempdigit));      
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe src="_s_n_t_p_01_customised_8c_a161e949048f06530e2b7bc36388d7241_cgraph.svg" width="584" height="59" frameborder="0" scrolling="no"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
</p>

</div>
</div>
<a class="anchor" id="adac06bc5849a60fe8b4739c26ff2cd8a"></a><!-- doxytag: member="SNTP Customised.c::HTTPPrint_NTPLastUpdate" ref="adac06bc5849a60fe8b4739c26ff2cd8a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void HTTPPrint_NTPLastUpdate </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Prints the last time update. </p>

<p>Definition at line <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00157">157</a> of file <a class="el" href="_s_n_t_p_01_customised_8c_source.html">SNTP Customised.c</a>.</p>

<p>References <a class="el" href="_custom_s_n_t_p_8c_source.html#l00134">dwLastUpdateTick</a>.</p>
<div class="fragment"><pre class="fragment">                                    {

<span class="preprocessor">#if defined(STACK_USE_SNTP_CLIENT)</span>
<span class="preprocessor"></span>        <span class="keywordtype">char</span> Tempdigit[12];

        uitoa(<a class="code" href="_custom_s_n_t_p_8c.html#a134d28a3f8166df7163955525f14b25d" title="Tick count of last update.">dwLastUpdateTick</a>,   Tempdigit);
        TCPPutArray(sktHTTP, Tempdigit, strlen((<span class="keywordtype">char</span>*)Tempdigit));      
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>}
</pre></div>
</div>
</div>
<a class="anchor" id="aab450595216ff490634099f3ec8efb55"></a><!-- doxytag: member="SNTP Customised.c::HTTPPrint_NTPServer" ref="aab450595216ff490634099f3ec8efb55" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void HTTPPrint_NTPServer </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Prints the NTP server that if configured. </p>

<p>Definition at line <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00140">140</a> of file <a class="el" href="_s_n_t_p_01_customised_8c_source.html">SNTP Customised.c</a>.</p>

<p>References <a class="el" href="_security_system_8h_source.html#l00220">xPLConfigs::NTP_Server</a>, and <a class="el" href="_security_system_8c_source.html#l00136">xPLConfig</a>.</p>
<div class="fragment"><pre class="fragment">                                {
        
        TCPPutArray(sktHTTP, <a class="code" href="_security_system_8c.html#adaa5e54872217e9a75a2bfdadf293d12" title="Configuration entries.">xPLConfig</a>.<a class="code" href="structx_p_l_configs.html#a70e871f8c8a200e0f5888f56f48e19f8" title="NTP Server name.">NTP_Server</a>, strlen(<a class="code" href="_security_system_8c.html#adaa5e54872217e9a75a2bfdadf293d12" title="Configuration entries.">xPLConfig</a>.<a class="code" href="structx_p_l_configs.html#a70e871f8c8a200e0f5888f56f48e19f8" title="NTP Server name.">NTP_Server</a>));       
}
</pre></div>
</div>
</div>
<a class="anchor" id="ab7d525c89c963594778df06040fc6748"></a><!-- doxytag: member="SNTP Customised.c::HTTPPrint_SNTPTestOutput" ref="ab7d525c89c963594778df06040fc6748" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void HTTPPrint_SNTPTestOutput </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>For debug purposes, prints the result code. </p>

<p>Definition at line <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00184">184</a> of file <a class="el" href="_s_n_t_p_01_customised_8c_source.html">SNTP Customised.c</a>.</p>

<p>References <a class="el" href="_h_t_t_p_variables_8c.html#a56dd5313e3ef1f8da6a1a98c9457eac1">curHTTP</a>, <a class="el" href="_security_system_8h_source.html#l00066">NTP_TEST_ARPERROR</a>, <a class="el" href="_security_system_8h_source.html#l00064">NTP_TEST_COMPLETED</a>, <a class="el" href="_security_system_8h_source.html#l00065">NTP_TEST_DNSERROR</a>, <a class="el" href="_security_system_8h_source.html#l00062">NTP_TEST_DONE</a>, <a class="el" href="_security_system_8h_source.html#l00067">NTP_TEST_TIMEOUT</a>, and <a class="el" href="_custom_s_n_t_p_8c_source.html#l00137">NTPTestResponse</a>.</p>
<div class="fragment"><pre class="fragment">                                     {
        
        <span class="comment">// Set a flag to indicate not finished</span>
        <a class="code" href="_h_t_t_p_variables_8c.html#a56dd5313e3ef1f8da6a1a98c9457eac1">curHTTP</a>.callbackPos = 1;

        <span class="comment">// Make sure there&#39;s enough output space</span>
        <span class="keywordflow">if</span>(TCPIsPutReady(sktHTTP) &lt; 15)
                <span class="keywordflow">return</span>;
        
        <span class="keywordflow">if</span> (<a class="code" href="_custom_s_n_t_p_8c.html#a6fec3fdfff459a953822db2e8ff9b462" title="stores the response from a SNTP test">NTPTestResponse</a> == <a class="code" href="_security_system_8h.html#a7adf00b67146dabd255490b21da8c1ff">NTP_TEST_COMPLETED</a>)
                TCPPutROMString(sktHTTP, (ROM BYTE*)<span class="stringliteral">&quot;Successful&quot;</span>);
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="_custom_s_n_t_p_8c.html#a6fec3fdfff459a953822db2e8ff9b462" title="stores the response from a SNTP test">NTPTestResponse</a> == <a class="code" href="_security_system_8h.html#ac64f79def39bca28f829bccccb2582d5">NTP_TEST_DNSERROR</a>)
                TCPPutROMString(sktHTTP, (ROM BYTE*)<span class="stringliteral">&quot;DNS error&quot;</span>);
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="_custom_s_n_t_p_8c.html#a6fec3fdfff459a953822db2e8ff9b462" title="stores the response from a SNTP test">NTPTestResponse</a> == <a class="code" href="_security_system_8h.html#af741b7e79e90c1eff3853206abd0ca60">NTP_TEST_ARPERROR</a>)
                TCPPutROMString(sktHTTP, (ROM BYTE*)<span class="stringliteral">&quot;ARP error&quot;</span>);
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="_custom_s_n_t_p_8c.html#a6fec3fdfff459a953822db2e8ff9b462" title="stores the response from a SNTP test">NTPTestResponse</a> == <a class="code" href="_security_system_8h.html#a635a61ffac11392ce261a74a5a1e48d9">NTP_TEST_TIMEOUT</a>)
                TCPPutROMString(sktHTTP, (ROM BYTE*)<span class="stringliteral">&quot;Time out&quot;</span>);
        <span class="keywordflow">else</span> 
                TCPPutROMString(sktHTTP, (ROM BYTE*)<span class="stringliteral">&quot;Error unkown&quot;</span>);
        
        <span class="comment">// Indicate that we&#39;re done</span>
        <a class="code" href="_h_t_t_p_variables_8c.html#a56dd5313e3ef1f8da6a1a98c9457eac1">curHTTP</a>.callbackPos = 0x00;
        <a class="code" href="_custom_s_n_t_p_8c.html#a6fec3fdfff459a953822db2e8ff9b462" title="stores the response from a SNTP test">NTPTestResponse</a> = <a class="code" href="_security_system_8h.html#a2ea42e00e0151b35178b5ddac534e048">NTP_TEST_DONE</a>;
        <span class="keywordflow">return</span>;         
}
</pre></div>
</div>
</div>
<a class="anchor" id="a7ee3d58d5355075489e71a6cd73dc307"></a><!-- doxytag: member="SNTP Customised.c::SNTPClient" ref="a7ee3d58d5355075489e71a6cd73dc307" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void SNTPClient </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00235">235</a> of file <a class="el" href="_s_n_t_p_01_customised_8c_source.html">SNTP Customised.c</a>.</p>

<p>References <a class="el" href="_custom_s_n_t_p_8c_source.html#l00134">dwLastUpdateTick</a>, <a class="el" href="_custom_s_n_t_p_8c_source.html#l00131">dwSNTPSeconds</a>, <a class="el" href="x_p_l_8h_source.html#l00004">FALSE</a>, <a class="el" href="struct___n_t_p___p_a_c_k_e_t.html#a5cd511bb2db4c4fc8e252a7bab6822e6">_NTP_PACKET::flags</a>, <a class="el" href="_custom_s_n_t_p_8c_source.html#l00108">_NTP_PACKET::mode</a>, <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00078">NTP_EPOCH</a>, <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00072">NTP_FAST_QUERY_INTERVAL</a>, <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00068">NTP_QUERY_INTERVAL</a>, <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00081">NTP_REPLY_TIMEOUT</a>, <a class="el" href="_security_system_8h_source.html#l00220">xPLConfigs::NTP_Server</a>, <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00075">NTP_SERVER_PORT</a>, <a class="el" href="_security_system_8h_source.html#l00066">NTP_TEST_ARPERROR</a>, <a class="el" href="_security_system_8h_source.html#l00064">NTP_TEST_COMPLETED</a>, <a class="el" href="_security_system_8h_source.html#l00065">NTP_TEST_DNSERROR</a>, <a class="el" href="_security_system_8h_source.html#l00067">NTP_TEST_TIMEOUT</a>, <a class="el" href="_custom_s_n_t_p_8c_source.html#l00137">NTPTestResponse</a>, <a class="el" href="_custom_s_n_t_p_8c_source.html#l00121">_NTP_PACKET::orig_ts_secs</a>, <a class="el" href="_hardware_profile_8h_source.html#l00204">putrsUART</a>, <a class="el" href="_security_system_8h_source.html#l00324">SM_ARP_RESOLVE</a>, <a class="el" href="_security_system_8h_source.html#l00326">SM_ARP_RESOLVE2</a>, <a class="el" href="_security_system_8h_source.html#l00328">SM_ARP_RESOLVE3</a>, <a class="el" href="_security_system_8h_source.html#l00329">SM_ARP_RESOLVE_FAIL</a>, <a class="el" href="_security_system_8h_source.html#l00323">SM_ARP_START_RESOLVE</a>, <a class="el" href="_security_system_8h_source.html#l00325">SM_ARP_START_RESOLVE2</a>, <a class="el" href="_security_system_8h_source.html#l00327">SM_ARP_START_RESOLVE3</a>, <a class="el" href="_security_system_8h_source.html#l00321">SM_HOME</a>, <a class="el" href="_security_system_8h_source.html#l00322">SM_NAME_RESOLVE</a>, <a class="el" href="_security_system_8h_source.html#l00332">SM_SHORT_WAIT</a>, <a class="el" href="_security_system_8h_source.html#l00331">SM_UDP_RECV</a>, <a class="el" href="_security_system_8h_source.html#l00330">SM_UDP_SEND</a>, <a class="el" href="_security_system_8h_source.html#l00333">SM_WAIT</a>, <a class="el" href="_custom_s_n_t_p_8c_source.html#l00138">SNTPState</a>, <a class="el" href="_security_system_8h_source.html#l00215">xPLConfigs::Use_AES</a>, <a class="el" href="_custom_s_n_t_p_8c_source.html#l00109">_NTP_PACKET::versionNumber</a>, and <a class="el" href="_security_system_8c_source.html#l00136">xPLConfig</a>.</p>
<div class="fragment"><pre class="fragment">{
        <a class="code" href="struct___n_t_p___p_a_c_k_e_t.html" title="Defines the structure of an NTP packet.">NTP_PACKET</a>                      pkt;
        WORD                            w;
        <span class="keyword">static</span> NODE_INFO        Server;
        <span class="keyword">static</span> DWORD            NTPdwTimer;
        <span class="keyword">static</span> UDP_SOCKET       MySocket;



        <span class="keywordflow">switch</span>(<a class="code" href="_custom_s_n_t_p_8c.html#ac6e22465161b7de2caf5f35cea78318e">SNTPState</a>)
        {
                <span class="keywordflow">case</span> <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99aea7247ebfc50d7f911c172da37f49e23">SM_HOME</a>:

<span class="comment">// JN added     next 2 lines                    </span>
                        <span class="comment">// If encryption is not needed then disable NTP</span>
<span class="preprocessor">                        #if defined(DEBUG_UART)</span>
<span class="preprocessor"></span>                                <a class="code" href="_hardware_profile_8h.html#afa49df8d2ce2ae222717e01eb8ed070e">putrsUART</a>((ROM <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;SNTP: started...\r\n&quot;</span>);
<span class="preprocessor">                        #endif</span>
<span class="preprocessor"></span>

                        <span class="keywordflow">if</span> (<a class="code" href="_security_system_8c.html#adaa5e54872217e9a75a2bfdadf293d12" title="Configuration entries.">xPLConfig</a>.<a class="code" href="structx_p_l_configs.html#aece9a02d06221a468e469a45e371be01" title="Use AES encryption on the user feild in the xPL message.">Use_AES</a> == <a class="code" href="x_p_l_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
                                <a class="code" href="_custom_s_n_t_p_8c.html#a6fec3fdfff459a953822db2e8ff9b462" title="stores the response from a SNTP test">NTPTestResponse</a> = <a class="code" href="_security_system_8h.html#a635a61ffac11392ce261a74a5a1e48d9">NTP_TEST_TIMEOUT</a>;
                                <span class="keywordflow">break</span>;
                        }
                        
<span class="preprocessor">                        #if defined(DEBUG_UART)</span>
<span class="preprocessor"></span>                                <a class="code" href="_hardware_profile_8h.html#afa49df8d2ce2ae222717e01eb8ed070e">putrsUART</a>((ROM <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;SNTP: started\r\n&quot;</span>);
<span class="preprocessor">                        #endif</span>
<span class="preprocessor"></span>                        <span class="comment">// Obtain ownership of the DNS resolution module</span>
                        <span class="keywordflow">if</span>(!DNSBeginUsage())
                                <span class="keywordflow">break</span>;

<span class="preprocessor">                        #if defined(DEBUG_UART)</span>
<span class="preprocessor"></span>                                <a class="code" href="_hardware_profile_8h.html#afa49df8d2ce2ae222717e01eb8ed070e">putrsUART</a>((ROM <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;SNTP: DNS ownership obtained\r\n&quot;</span>);
<span class="preprocessor">                        #endif</span>
<span class="preprocessor"></span>                                
<span class="comment">// JN changed next 2 lines</span>
                        <span class="comment">// Obtain the IP address associated with the server name</span>
                        <span class="comment">//DNSResolveROM((ROM BYTE*)NTP_SERVER, DNS_TYPE_A);</span>
                        DNSResolve((BYTE*) <a class="code" href="_security_system_8c.html#adaa5e54872217e9a75a2bfdadf293d12" title="Configuration entries.">xPLConfig</a>.<a class="code" href="structx_p_l_configs.html#a70e871f8c8a200e0f5888f56f48e19f8" title="NTP Server name.">NTP_Server</a>,  DNS_TYPE_A);
                        
                        NTPdwTimer = TickGet();
                        <a class="code" href="_custom_s_n_t_p_8c.html#ac6e22465161b7de2caf5f35cea78318e">SNTPState</a> = <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99a1f6f83753731af083a737fba12f962dd">SM_NAME_RESOLVE</a>;
                        <span class="keywordflow">break</span>;

                <span class="keywordflow">case</span> <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99a1f6f83753731af083a737fba12f962dd">SM_NAME_RESOLVE</a>:
                        <span class="comment">// Wait for DNS resolution to complete</span>
                        <span class="keywordflow">if</span>(!DNSIsResolved(&amp;Server.IPAddr)) 
                        {
                                <span class="keywordflow">if</span>((TickGet() - NTPdwTimer) &gt; (5 * TICK_SECOND)) 
                                {
                                        DNSEndUsage();
                                        NTPdwTimer = TickGetDiv64K();
                                        <a class="code" href="_custom_s_n_t_p_8c.html#ac6e22465161b7de2caf5f35cea78318e">SNTPState</a> = <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99a2c17b68ae4178611296803bc0788eb07">SM_SHORT_WAIT</a>;
                                        <a class="code" href="_custom_s_n_t_p_8c.html#a6fec3fdfff459a953822db2e8ff9b462" title="stores the response from a SNTP test">NTPTestResponse</a> = <a class="code" href="_security_system_8h.html#ac64f79def39bca28f829bccccb2582d5">NTP_TEST_DNSERROR</a>;
<span class="preprocessor">                                        #if defined(DEBUG_UART)</span>
<span class="preprocessor"></span>                                                <a class="code" href="_hardware_profile_8h.html#afa49df8d2ce2ae222717e01eb8ed070e">putrsUART</a>((ROM <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;SNTP: DNS did not resolve in time\r\n&quot;</span>);
<span class="preprocessor">                                        #endif</span>
<span class="preprocessor"></span>                                }
                                <span class="keywordflow">break</span>;
                        }
                        
                        <span class="comment">// Obtain DNS resolution result</span>
                        <span class="keywordflow">if</span>(!DNSEndUsage())
                        {
                                <span class="comment">// No valid IP address was returned from the DNS </span>
                                <span class="comment">// server.  Quit and fail for a while if host is not valid.</span>
                                NTPdwTimer = TickGetDiv64K();
                                <a class="code" href="_custom_s_n_t_p_8c.html#ac6e22465161b7de2caf5f35cea78318e">SNTPState</a> = <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99a2c17b68ae4178611296803bc0788eb07">SM_SHORT_WAIT</a>;
                                <a class="code" href="_custom_s_n_t_p_8c.html#a6fec3fdfff459a953822db2e8ff9b462" title="stores the response from a SNTP test">NTPTestResponse</a> = <a class="code" href="_security_system_8h.html#ac64f79def39bca28f829bccccb2582d5">NTP_TEST_DNSERROR</a>;
                                <span class="keywordflow">break</span>;
                        }
                        <a class="code" href="_custom_s_n_t_p_8c.html#ac6e22465161b7de2caf5f35cea78318e">SNTPState</a> = <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99a4246a915d3fac96d3b99ea2f7f0b75e4">SM_ARP_START_RESOLVE</a>;
                        <span class="comment">// No need to break</span>

                <span class="keywordflow">case</span> <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99a4246a915d3fac96d3b99ea2f7f0b75e4">SM_ARP_START_RESOLVE</a>:
                <span class="keywordflow">case</span> <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99ae577e7e208397623d1cfd9c2708f6ae7">SM_ARP_START_RESOLVE2</a>:
                <span class="keywordflow">case</span> <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99a6ce6bcc9ff6b9526a8a290e92c660372">SM_ARP_START_RESOLVE3</a>:
                        <span class="comment">// Obtain the MAC address associated with the server&#39;s IP address </span>
                        ARPResolve(&amp;Server.IPAddr);
                        NTPdwTimer = TickGet();
                        <a class="code" href="_custom_s_n_t_p_8c.html#ac6e22465161b7de2caf5f35cea78318e">SNTPState</a>++;
                
<span class="preprocessor">                        #if defined(DEBUG_UART)</span>
<span class="preprocessor"></span>                                <a class="code" href="_hardware_profile_8h.html#afa49df8d2ce2ae222717e01eb8ed070e">putrsUART</a>((ROM <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;SNTP: start ARP\r\n&quot;</span>);
<span class="preprocessor">                        #endif</span>
<span class="preprocessor"></span>                        
                        <span class="keywordflow">break</span>;

                <span class="keywordflow">case</span> <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99a4b1f504478c3adb46b8bddd341cf431e">SM_ARP_RESOLVE</a>:
                <span class="keywordflow">case</span> <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99afd4aea26a60199760d9258c41915fabb">SM_ARP_RESOLVE2</a>:
                <span class="keywordflow">case</span> <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99a19aa474b1a067f0f328e4e7626dadb87">SM_ARP_RESOLVE3</a>:
                        <span class="comment">// Wait for the MAC address to finish being obtained</span>
                        <span class="keywordflow">if</span>(!ARPIsResolved(&amp;Server.IPAddr, &amp;Server.MACAddr))
                        {
                                <span class="comment">// Time out if too much time is spent in this state</span>
                                <span class="keywordflow">if</span>(TickGet() - NTPdwTimer &gt; 1*TICK_SECOND)
                                {
                                        <span class="comment">// Retransmit ARP request by going to next SM_ARP_START_RESOLVE state or fail by going to SM_ARP_RESOLVE_FAIL state.</span>
                                        <a class="code" href="_custom_s_n_t_p_8c.html#ac6e22465161b7de2caf5f35cea78318e">SNTPState</a>++;
                                }
                                <span class="keywordflow">break</span>;
                        }
                        <a class="code" href="_custom_s_n_t_p_8c.html#ac6e22465161b7de2caf5f35cea78318e">SNTPState</a> = <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99a8f906883b6328da991d03aa022af415d">SM_UDP_SEND</a>;
                        <span class="keywordflow">break</span>;

                <span class="keywordflow">case</span> <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99abc595e4a4c3d4088da4edff772442822">SM_ARP_RESOLVE_FAIL</a>:
                        <span class="comment">// ARP failed after 3 tries, abort and wait for next time query</span>
                        NTPdwTimer = TickGetDiv64K();
                        <a class="code" href="_custom_s_n_t_p_8c.html#ac6e22465161b7de2caf5f35cea78318e">SNTPState</a> = <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99a2c17b68ae4178611296803bc0788eb07">SM_SHORT_WAIT</a>;
                        <a class="code" href="_custom_s_n_t_p_8c.html#a6fec3fdfff459a953822db2e8ff9b462" title="stores the response from a SNTP test">NTPTestResponse</a> = <a class="code" href="_security_system_8h.html#af741b7e79e90c1eff3853206abd0ca60">NTP_TEST_ARPERROR</a>;
<span class="preprocessor">                        #if defined(DEBUG_UART)</span>
<span class="preprocessor"></span>                                <a class="code" href="_hardware_profile_8h.html#afa49df8d2ce2ae222717e01eb8ed070e">putrsUART</a>((ROM <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;SNTP: ARP failed\r\n&quot;</span>);
<span class="preprocessor">                        #endif</span>
<span class="preprocessor"></span>
                        <span class="keywordflow">break</span>;

                <span class="keywordflow">case</span> <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99a8f906883b6328da991d03aa022af415d">SM_UDP_SEND</a>:
                        <span class="comment">// Open up the sending UDP socket</span>
<span class="preprocessor">                        #if defined(DEBUG_UART)</span>
<span class="preprocessor"></span>                                <a class="code" href="_hardware_profile_8h.html#afa49df8d2ce2ae222717e01eb8ed070e">putrsUART</a>((ROM <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;SNTP: UDP send\r\n&quot;</span>);
<span class="preprocessor">                        #endif</span>
<span class="preprocessor"></span>                        MySocket = UDPOpen(0, &amp;Server, <a class="code" href="_s_n_t_p_01_customised_8c.html#a57df452a6d54697643631ce3039623d4" title="Port for contacting NTP servers.">NTP_SERVER_PORT</a>);
                        <span class="keywordflow">if</span>(MySocket == INVALID_UDP_SOCKET)
                                <span class="keywordflow">break</span>;

                        <span class="comment">// Make certain the socket can be written to</span>
                        <span class="keywordflow">if</span>(!UDPIsPutReady(MySocket))
                        {
                                UDPClose(MySocket);
                                <span class="keywordflow">break</span>;
                        }

                        <span class="comment">// Transmit a time request packet</span>
                        memset(&amp;pkt, 0, <span class="keyword">sizeof</span>(pkt));
                        pkt.<a class="code" href="struct___n_t_p___p_a_c_k_e_t.html#a5cd511bb2db4c4fc8e252a7bab6822e6" title="Flags for the packet.">flags</a>.<a class="code" href="struct___n_t_p___p_a_c_k_e_t.html#a92be62771d87971c4589ccf08f4ea514" title="SNTP version number.">versionNumber</a> = 3;    <span class="comment">// NTP Version 3</span>
                        pkt.<a class="code" href="struct___n_t_p___p_a_c_k_e_t.html#a5cd511bb2db4c4fc8e252a7bab6822e6" title="Flags for the packet.">flags</a>.<a class="code" href="struct___n_t_p___p_a_c_k_e_t.html#ae85cfacc6e01703aa637c1f13ea4b36f" title="NTP mode.">mode</a> = 3;                             <span class="comment">// NTP Client</span>
                        pkt.<a class="code" href="struct___n_t_p___p_a_c_k_e_t.html#ac7ac0acfc4ad5ca95561c4df36f93552" title="Origination timestamp (in seconds)">orig_ts_secs</a> = swapl(<a class="code" href="_s_n_t_p_01_customised_8c.html#a600d45a89709a133823847c1f15925dd" title="Reference Epoch to use. (default: 01-Jan-1970 00:00:00)">NTP_EPOCH</a>);
                        UDPPutArray((BYTE*) &amp;pkt, <span class="keyword">sizeof</span>(pkt)); 
                        UDPFlush();     
                        
                        NTPdwTimer = TickGet();
                        <a class="code" href="_custom_s_n_t_p_8c.html#ac6e22465161b7de2caf5f35cea78318e">SNTPState</a> = <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99af63ee3ca9b5cb06f91cd51344ef58084">SM_UDP_RECV</a>;                
                        <span class="keywordflow">break</span>;

                <span class="keywordflow">case</span> <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99af63ee3ca9b5cb06f91cd51344ef58084">SM_UDP_RECV</a>:
                        <span class="comment">// Look for a response time packet</span>
                        <span class="keywordflow">if</span>(!UDPIsGetReady(MySocket)) 
                        {
                                <span class="keywordflow">if</span>((TickGet()) - NTPdwTimer &gt; <a class="code" href="_s_n_t_p_01_customised_8c.html#ae0247c4467b3305a0b009bc4e032b23a" title="Defines how long to wait before assuming the require has failed.">NTP_REPLY_TIMEOUT</a>)
                                {
                                        <span class="comment">// Abort the request and wait until the next timeout period</span>
                                        UDPClose(MySocket);
                                        NTPdwTimer = TickGetDiv64K();
                                        <a class="code" href="_custom_s_n_t_p_8c.html#ac6e22465161b7de2caf5f35cea78318e">SNTPState</a> = <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99a2c17b68ae4178611296803bc0788eb07">SM_SHORT_WAIT</a>;
                                        <a class="code" href="_custom_s_n_t_p_8c.html#a6fec3fdfff459a953822db2e8ff9b462" title="stores the response from a SNTP test">NTPTestResponse</a> = <a class="code" href="_security_system_8h.html#a635a61ffac11392ce261a74a5a1e48d9">NTP_TEST_TIMEOUT</a>;
<span class="preprocessor">                                        #if defined(DEBUG_UART)</span>
<span class="preprocessor"></span>                                                <a class="code" href="_hardware_profile_8h.html#afa49df8d2ce2ae222717e01eb8ed070e">putrsUART</a>((ROM <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;SNTP: No response\r\n&quot;</span>);
<span class="preprocessor">                                        #endif</span>
<span class="preprocessor"></span>                                        <span class="keywordflow">break</span>;
                                }
                                <span class="keywordflow">break</span>;
                        }
                        
<span class="preprocessor">                        #if defined(DEBUG_UART)</span>
<span class="preprocessor"></span>                                <a class="code" href="_hardware_profile_8h.html#afa49df8d2ce2ae222717e01eb8ed070e">putrsUART</a>((ROM <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;SNTP: UDP received\r\n&quot;</span>);
<span class="preprocessor">                        #endif</span>
<span class="preprocessor"></span>                        
                        <span class="comment">// Get the response time packet</span>
                        w = UDPGetArray((BYTE*) &amp;pkt, <span class="keyword">sizeof</span>(pkt));
                        UDPClose(MySocket);
                        NTPdwTimer = TickGetDiv64K();
                        <a class="code" href="_custom_s_n_t_p_8c.html#ac6e22465161b7de2caf5f35cea78318e">SNTPState</a> = <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99a030e7676ddc0611f9db274ad2c0e1bad">SM_WAIT</a>;

                        <span class="comment">// Validate packet size</span>
                        <span class="keywordflow">if</span>(w != <span class="keyword">sizeof</span>(pkt)) 
                        {
                                <span class="keywordflow">break</span>;  
                        }
                        
                        <span class="comment">// Set out local time to match the returned time</span>
                        <a class="code" href="_custom_s_n_t_p_8c.html#a134d28a3f8166df7163955525f14b25d" title="Tick count of last update.">dwLastUpdateTick</a> = TickGet();
                        <a class="code" href="_custom_s_n_t_p_8c.html#afbf3efc6491790a0a132b97f2fd78e4a" title="Seconds value obtained by last update.">dwSNTPSeconds</a> = swapl(pkt.tx_ts_secs) - <a class="code" href="_s_n_t_p_01_customised_8c.html#a600d45a89709a133823847c1f15925dd" title="Reference Epoch to use. (default: 01-Jan-1970 00:00:00)">NTP_EPOCH</a>;
                        <span class="comment">// Do rounding.  If the partial seconds is &gt; 0.5 then add 1 to the seconds count.</span>
                        <span class="keywordflow">if</span>(((BYTE*)&amp;pkt.tx_ts_fraq)[0] &amp; 0x80)
                                <a class="code" href="_custom_s_n_t_p_8c.html#afbf3efc6491790a0a132b97f2fd78e4a" title="Seconds value obtained by last update.">dwSNTPSeconds</a>++;

                        <span class="keywordflow">break</span>;

                <span class="keywordflow">case</span> <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99a2c17b68ae4178611296803bc0788eb07">SM_SHORT_WAIT</a>:
                        <span class="comment">// Attempt to requery the NTP server after a specified NTP_FAST_QUERY_INTERVAL time (ex: 8 seconds) has elapsed.</span>
                        <span class="keywordflow">if</span>(TickGetDiv64K() - NTPdwTimer &gt; (<a class="code" href="_s_n_t_p_01_customised_8c.html#af50690220da7a646605fbb6ca213500a">NTP_FAST_QUERY_INTERVAL</a>/65536ull))
                                <a class="code" href="_custom_s_n_t_p_8c.html#ac6e22465161b7de2caf5f35cea78318e">SNTPState</a> = <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99aea7247ebfc50d7f911c172da37f49e23">SM_HOME</a>;    
                        <span class="keywordflow">break</span>;

                <span class="keywordflow">case</span> <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99a030e7676ddc0611f9db274ad2c0e1bad">SM_WAIT</a>:
                        
                        <a class="code" href="_custom_s_n_t_p_8c.html#a6fec3fdfff459a953822db2e8ff9b462" title="stores the response from a SNTP test">NTPTestResponse</a> = <a class="code" href="_security_system_8h.html#a7adf00b67146dabd255490b21da8c1ff">NTP_TEST_COMPLETED</a>;
                        <span class="comment">// Requery the NTP server after a specified NTP_QUERY_INTERVAL time (ex: 10 minutes) has elapsed.</span>
                        <span class="keywordflow">if</span>(TickGetDiv64K() - NTPdwTimer &gt; (<a class="code" href="_s_n_t_p_01_customised_8c.html#a5fa19ad7b1377cb36ed0f84b32dcfc28" title="Defines how frequently to resynchronize the date/time (default: 10 minutes)">NTP_QUERY_INTERVAL</a>/65536ull))
                                <a class="code" href="_custom_s_n_t_p_8c.html#ac6e22465161b7de2caf5f35cea78318e">SNTPState</a> = <a class="code" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99aea7247ebfc50d7f911c172da37f49e23">SM_HOME</a>;    

                        <span class="keywordflow">break</span>;
        }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a3a2bcda2ac33aacd49d652a93f9031b1"></a><!-- doxytag: member="SNTP Customised.c::SNTPGetUTCSeconds" ref="a3a2bcda2ac33aacd49d652a93f9031b1" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">DWORD SNTPGetUTCSeconds </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00468">468</a> of file <a class="el" href="_s_n_t_p_01_customised_8c_source.html">SNTP Customised.c</a>.</p>

<p>References <a class="el" href="_custom_s_n_t_p_8c_source.html#l00134">dwLastUpdateTick</a>, and <a class="el" href="_custom_s_n_t_p_8c_source.html#l00131">dwSNTPSeconds</a>.</p>
<div class="fragment"><pre class="fragment">{
        DWORD dwTickDelta;
        DWORD dwTick;

        <span class="comment">// Update the dwSNTPSeconds variable with the number of seconds </span>
        <span class="comment">// that has elapsed</span>
        dwTick = TickGet();
        dwTickDelta = dwTick - <a class="code" href="_custom_s_n_t_p_8c.html#a134d28a3f8166df7163955525f14b25d" title="Tick count of last update.">dwLastUpdateTick</a>;
        <span class="keywordflow">while</span>(dwTickDelta &gt; TICK_SECOND)
        {
                <a class="code" href="_custom_s_n_t_p_8c.html#afbf3efc6491790a0a132b97f2fd78e4a" title="Seconds value obtained by last update.">dwSNTPSeconds</a>++;
                dwTickDelta -= TICK_SECOND;
        }
        
        <span class="comment">// Save the tick and residual fractional seconds for the next call</span>
        dwLastUpdateTick = dwTick - dwTickDelta;

        <span class="keywordflow">return</span> <a class="code" href="_custom_s_n_t_p_8c.html#afbf3efc6491790a0a132b97f2fd78e4a" title="Seconds value obtained by last update.">dwSNTPSeconds</a>;
}
</pre></div>
</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="a134d28a3f8166df7163955525f14b25d"></a><!-- doxytag: member="SNTP Customised.c::dwLastUpdateTick" ref="a134d28a3f8166df7163955525f14b25d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">DWORD <a class="el" href="_s_n_t_p_01_customised_8c.html#a134d28a3f8166df7163955525f14b25d">dwLastUpdateTick</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Tick count of last update. </p>

<p>Definition at line <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00132">132</a> of file <a class="el" href="_s_n_t_p_01_customised_8c_source.html">SNTP Customised.c</a>.</p>

</div>
</div>
<a class="anchor" id="afbf3efc6491790a0a132b97f2fd78e4a"></a><!-- doxytag: member="SNTP Customised.c::dwSNTPSeconds" ref="afbf3efc6491790a0a132b97f2fd78e4a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">DWORD <a class="el" href="_s_n_t_p_01_customised_8c.html#afbf3efc6491790a0a132b97f2fd78e4a">dwSNTPSeconds</a> = 0</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Seconds value obtained by last update. </p>

<p>Definition at line <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00129">129</a> of file <a class="el" href="_s_n_t_p_01_customised_8c_source.html">SNTP Customised.c</a>.</p>

</div>
</div>
<a class="anchor" id="a6fec3fdfff459a953822db2e8ff9b462"></a><!-- doxytag: member="SNTP Customised.c::NTPTestResponse" ref="a6fec3fdfff459a953822db2e8ff9b462" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="_s_n_t_p_01_customised_8c.html#a6fec3fdfff459a953822db2e8ff9b462">NTPTestResponse</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>stores the response from a SNTP test </p>

<p>Definition at line <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00135">135</a> of file <a class="el" href="_s_n_t_p_01_customised_8c_source.html">SNTP Customised.c</a>.</p>

</div>
</div>
<a class="anchor" id="ac6e22465161b7de2caf5f35cea78318e"></a><!-- doxytag: member="SNTP Customised.c::SNTPState" ref="ac6e22465161b7de2caf5f35cea78318e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_security_system_8h.html#a3e4d7c3657d49c0a82757c17fb3e4a99">SNTPStates</a> <a class="el" href="_s_n_t_p_01_customised_8c.html#ac6e22465161b7de2caf5f35cea78318e">SNTPState</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_s_n_t_p_01_customised_8c_source.html#l00136">136</a> of file <a class="el" href="_s_n_t_p_01_customised_8c_source.html">SNTP Customised.c</a>.</p>

</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Mon Apr 25 2011 23:16:37 for Alarm Cabinent by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
